# Guilty アプリケーション仕様書

## 1. 概要

Guiltyは、リモートGitリポジトリを管理するためのWebベースのアプリケーションです。ユーザーは複数のGitリポジトリの一覧表示、リポジトリ内のファイル閲覧、コミット履歴の確認などが可能です。主にベアリポジトリの表示を想定していますが、通常のGitリポジトリにも対応しています。また、リポジトリの作成や削除などの基本的な管理機能も提供しています。グループ機能により、リポジトリを論理的に整理することができます。

## 2. システム構成

### バックエンド
- 言語: Go言語
- Webサーバー: 標準のhttpパッケージを使用
- 外部依存: gitコマンドライン

### フロントエンド
- フレームワーク: Vue.js
- CSSフレームワーク: Bootstrap
- HTTPクライアント: Axios
- 共通ユーティリティ: GuiltyUtils（URL生成など）

## 3. アプリケーション構造

```
guilty/
  ├── main.go              # メインのGoプログラム（バックエンドAPI）
  ├── go.mod               # Goモジュール定義
  ├── Makefile             # ビルド設定
  ├── guilty.service       # systemdサービス設定ファイル
  ├── static/              # 静的ファイル
  │   ├── css/
  │   │   └── style.css    # カスタムCSSスタイル
  │   ├── js/
  │   │   ├── app.js       # メインページVueアプリ
  │   │   ├── main.js      # 共通JavaScript（GuiltyUtils含む）
  │   │   ├── repository.js # リポジトリ詳細ページVueアプリ
  │   │   └── create-repository.js # リポジトリ作成ページVueアプリ
  │   └── lib/             # 外部ライブラリ
  │       ├── bootstrap/   # Bootstrapライブラリ
  │       ├── vue/         # Vue.jsライブラリ
  │       └── axios/       # Axiosライブラリ
  └── templates/           # HTMLテンプレート
      ├── index.html       # メインページのテンプレート
      ├── repository.html  # リポジトリ詳細ページのテンプレート
      └── create-repository.html # リポジトリ作成ページのテンプレート
```

## 4. 主要な機能

### 4.1 リポジトリリスト表示
- 指定ディレクトリ（デフォルトは`/mnt/git`）にあるGitリポジトリの一覧表示
- グループ（サブディレクトリ）によるリポジトリの整理と選択
- リポジトリ名、パス、最終コミット情報の表示
- 最終コミット日時順のソート（新しい順）
- リポジトリ名や内容による検索フィルタリング
- 新規リポジトリ作成ページへの遷移ボタン

### 4.2 リポジトリ詳細表示
- リポジトリの基本情報表示（名前、グループ、最終コミット情報）
- クローンURL表示とコピー機能
- ファイル・ディレクトリツリーの表示と閲覧
- ディレクトリ間のナビゲーション（パンくずリスト対応）
- ファイル名による検索フィルタリング
- リポジトリの削除機能（確認ダイアログ付き）

### 4.3 ファイル内容表示
- テキストファイルの内容をモーダルウィンドウで表示
- バイナリファイルの判定と表示制限
- ファイルサイズと最終更新日時の表示

### 4.4 リポジトリ管理機能
- 新規リポジトリの作成（ベアリポジトリ）
  - グループ選択機能
  - リポジトリ名のバリデーション（不正な文字のチェック）
  - 既存リポジトリ名との重複チェック
- リポジトリの削除（論理削除）
  - 削除確認ダイアログの表示
  - リポジトリファイルの名前変更と権限変更による論理削除

### 4.5 グループ機能
- `/mnt/git`のサブディレクトリをグループとして認識
- グループ名のバリデーション（`-`と`_`のみ許可）
- 特定のグループ名を除外（例：`git-shell-commands`）
- グループ選択によるリポジトリのフィルタリング
- グループを指定した新規リポジトリ作成

### 4.6 その他機能
- リポジトリの種類判定（通常/ベア）
- ブランチとタグのリスト取得（APIレベルで対応）
- コミットがないリポジトリの適切な表示と説明
- 読み取り権限のないリポジトリの表示から除外
- URL生成のための共通ユーティリティ関数

## 5. API仕様

### 5.1 `/api/repositories`
- **メソッド**: GET
- **パラメータ**: `group` - グループ名（オプション）
- **説明**: 指定されたグループまたはすべてのGitリポジトリのリストを返す
- **レスポンス**: GitRepositoryオブジェクトの配列

- **メソッド**: POST
- **説明**: 新しいGitリポジトリを作成する
- **リクエストボディ**: 
  ```
  {
    "name": "リポジトリ名",
    "group": "グループ名"
  }
  ```
- **レスポンス**: 成功メッセージまたはエラーメッセージ

### 5.2 `/api/repository/{groupName}/{repoName}`
- **メソッド**: GET
- **説明**: 指定したリポジトリの詳細情報を返す
- **パラメータ**: 
  - `groupName` - グループ名（URLエンコード）
  - `repoName` - リポジトリ名（URLエンコード）
- **レスポンス**: RepositoryDetailsオブジェクト（リポジトリ情報、ファイル一覧、ブランチ、タグ）

- **メソッド**: POST
- **説明**: リポジトリに対する操作を実行する（例：削除）
- **パラメータ**: 
  - `groupName` - グループ名（URLエンコード）
  - `repoName` - リポジトリ名（URLエンコード）
- **リクエストボディ**: 
  ```
  {
    "operation": "delete"
  }
  ```
- **レスポンス**: 成功メッセージまたはエラーメッセージ

### 5.3 `/api/directory/{groupName}/{repoName}/{dirPath}`
- **メソッド**: GET
- **説明**: 指定したディレクトリ内のファイルとサブディレクトリのリストを返す
- **パラメータ**: 
  - `groupName` - グループ名（URLエンコード）
  - `repoName` - リポジトリ名（URLエンコード）
  - `dirPath` - ディレクトリのパス（URLエンコード）
- **レスポンス**: GitFileオブジェクトの配列

### 5.4 `/api/file/{groupName}/{repoName}/{filePath}`
- **メソッド**: GET
- **説明**: 指定したファイルの内容を返す
- **パラメータ**: 
  - `groupName` - グループ名（URLエンコード）
  - `repoName` - リポジトリ名（URLエンコード）
  - `filePath` - ファイルのパス（URLエンコード）
- **レスポンス**: ファイルの内容とバイナリかどうかのフラグ

### 5.5 `/api/groups`
- **メソッド**: GET
- **説明**: 利用可能なすべてのグループのリストを返す
- **レスポンス**: グループ名の配列

## 6. データモデル

### 6.1 GitRepository
- `path`: リポジトリのパス
- `name`: リポジトリの名前
- `group`: リポジトリのグループ名
- `type`: リポジトリの種類（"normal" または "bare"）
- `cloneUrl`: リポジトリのクローンURL（git@hostname:group/reponame.git形式）
- `lastCommit`: 最新のコミット情報（CommitInfo）

### 6.2 CommitInfo
- `author`: コミット作者の名前
- `date`: コミット日時
- `message`: コミットメッセージ

### 6.3 GitFile
- `name`: ファイル名
- `path`: ファイルのパス
- `type`: ファイルの種類（"file" または "dir"）
- `size`: ファイルサイズ（バイト単位）
- `lastModified`: 最終更新日時

### 6.4 RepositoryDetails
- `repository`: GitRepositoryオブジェクト
- `files`: GitFileオブジェクトの配列
- `branches`: ブランチ名の配列
- `tags`: タグ名の配列

### 6.5 CreateRepositoryRequest
- `name`: 作成するリポジトリの名前
- `group`: リポジトリを作成するグループ名

## 7. UIコンポーネント

### 7.1 リポジトリリスト（app.js）
- グループ選択ドロップダウン
- リポジトリ一覧表示テーブル
- 検索フィルターボックス
- リポジトリエントリコンポーネント
- 新規リポジトリ作成ボタン

### 7.2 リポジトリ詳細（repository.js）
- リポジトリ情報カード
- クローンURL表示とコピーボタン
- ファイル一覧テーブル
- パンくずリストナビゲーション
- ファイル内容モーダル表示
- 検索フィルターボックス
- リポジトリ削除ボタンと確認モーダル

### 7.3 リポジトリ作成（create-repository.js）
- グループ選択ドロップダウン
- リポジトリ名入力フォーム
- バリデーションメッセージ表示
- 作成ボタン
- 成功/エラーメッセージ表示

## 8. JavaScript共通ユーティリティ（GuiltyUtils）

GuiltyUtilsは、URL生成などの共通機能を提供するグローバルオブジェクトです。

### 8.1 主要なユーティリティ関数
- `_getEncodedPath`: グループ名とリポジトリ名をURLエンコードして連結
- `getRepositoryUrl`: リポジトリ詳細ページのURLを生成
- `getApiRepositoryPath`: リポジトリAPIのURLパスを生成
- `getApiFilePath`: ファイル取得APIのURLパスを生成
- `getApiDirectoryPath`: ディレクトリ取得APIのURLパスを生成
- `getRepositoriesApiUrl`: リポジトリ一覧APIのURLを生成
- `getRepositoriesPageUrl`: リポジトリ一覧ページのURLを生成
- `getCreateRepositoryUrl`: リポジトリ作成ページのURLを生成

## 9. セキュリティ対策

- パス走査攻撃防止機能（ディレクトリトラバーサル対策）
- クロスオリジンリソース共有（CORS）対応
- エラーメッセージの適切な処理
- リポジトリ名のバリデーション（不正な文字チェック）
- グループ名のバリデーション（許可される記号の制限）

## 10. システムデプロイと管理

### 10.1 インストール
- 実行ファイル `/usr/local/bin/guilty` にインストール
- 静的ファイルとテンプレートは `/usr/local/share/guilty` に配置

### 10.2 systemdによるサービス管理
- サービス名: `guilty.service`
- 自動起動設定: `sudo systemctl enable guilty`
- サービス開始: `sudo systemctl start guilty`
- サービス状態確認: `sudo systemctl status guilty`

### 10.3 リポジトリの削除処理
- リポジトリを完全に削除するのではなく論理削除を行う
- 削除処理のステップ:
  1. リポジトリのパスに `.deleted` を付加（例: `/mnt/git/group/MyProject.git` → `/mnt/git/group/MyProject.git.deleted`）
  2. 削除済みリポジトリが存在する場合、新しく削除する前に `chmod 777` を実行して権限を変更
  3. 変更後のディレクトリに対して `chmod 000` を実行し、アクセス不能にする

### 10.4 クローンURL
- クローン用URLは環境変数またはメタタグで設定可能なホスト名を使用（デフォルトは `localhost`）
- 形式: `git@hostname:group/repositoryname.git`

### 10.5 環境設定
- Gitリポジトリのルートディレクトリは定数 `GitRepositoryRoot` で定義（デフォルト: `/mnt/git`）
- Gitホストのホスト名は変数 `GitHostName` で設定可能

## 11. 制限事項

- デフォルトでは `/mnt/git` ディレクトリのみをスキャン
- グループ名で使用できる記号は `-` と `_` のみ
- バイナリファイルの内容は表示不可
- 大規模なリポジトリやファイルのパフォーマンス最適化は未実装
- 複雑なGit操作（コミット、プッシュなど）は未対応
- 読み取り権限のないディレクトリはスキップされる

## 12. 将来的な拡張可能性

- ユーザー認証・認可機能
- コミット履歴の詳細表示
- ファイル差分（diff）の表示
- ブランチ間の比較機能
- アクセス制限・権限管理
- リポジトリのフォーク機能
- プルリクエスト機能
- グループのネスト（サブグループ）対応